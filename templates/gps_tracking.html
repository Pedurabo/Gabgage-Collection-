{% extends "base.html" %}

{% block title %}GPS Tracking{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">
                    <i class="fas fa-satellite text-success"></i>
                    Live GPS Tracking
                </h2>
                <div class="btn-group" role="group">
                    <button class="btn btn-outline-success" onclick="refreshGPS()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button class="btn btn-outline-primary" onclick="toggleAutoRefresh()">
                        <i class="fas fa-play" id="autoRefreshIcon"></i> 
                        <span id="autoRefreshText">Auto Refresh</span>
                    </button>
                </div>
            </div>

            <!-- Live Vehicle Status -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Active Vehicles</h6>
                                    <h3 class="mb-0" id="activeVehicles">0</h3>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-truck fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Total Distance</h6>
                                    <h3 class="mb-0" id="totalDistance">0 km</h3>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-route fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Avg Speed</h6>
                                    <h3 class="mb-0" id="avgSpeed">0 km/h</h3>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-tachometer-alt fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Fuel Level</h6>
                                    <h3 class="mb-0" id="avgFuelLevel">0%</h3>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-gas-pump fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Map and Vehicle List -->
            <div class="row">
                <div class="col-lg-8">
                    <div class="card shadow">
                        <div class="card-header bg-white">
                            <h5 class="mb-0">
                                <i class="fas fa-map-marked-alt"></i> Live Vehicle Map
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            <div id="map" style="height: 500px; width: 100%;"></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card shadow">
                        <div class="card-header bg-white">
                            <h5 class="mb-0">
                                <i class="fas fa-list"></i> Vehicle Status
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="vehicleList">
                                <!-- Vehicle cards will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Historical Tracking -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card shadow">
                        <div class="card-header bg-white">
                            <h5 class="mb-0">
                                <i class="fas fa-history"></i> Historical Tracking Data
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Vehicle</th>
                                            <th>Location</th>
                                            <th>Speed</th>
                                            <th>Heading</th>
                                            <th>Fuel Level</th>
                                            <th>Last Update</th>
                                        </tr>
                                    </thead>
                                    <tbody id="trackingTable">
                                        {% for track in tracking_data %}
                                        <tr>
                                            <td>
                                                <strong>{{ track.vehicle.vehicle_number }}</strong>
                                            </td>
                                            <td>
                                                {{ "%.4f"|format(track.latitude) }}, {{ "%.4f"|format(track.longitude) }}
                                            </td>
                                            <td>
                                                <span class="badge bg-{{ 'success' if track.speed > 30 else 'warning' if track.speed > 10 else 'secondary' }}">
                                                    {{ "%.1f"|format(track.speed or 0) }} km/h
                                                </span>
                                            </td>
                                            <td>
                                                <i class="fas fa-compass" style="transform: rotate({{ track.heading or 0 }}deg)"></i>
                                                {{ "%.0f"|format(track.heading or 0) }}°
                                            </td>
                                            <td>
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar bg-{{ 'success' if (track.battery_level or 0) > 50 else 'warning' if (track.battery_level or 0) > 20 else 'danger' }}" 
                                                         style="width: {{ track.battery_level or 0 }}%">
                                                        {{ "%.0f"|format(track.battery_level or 0) }}%
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <small class="text-muted">{{ track.timestamp.strftime('%H:%M:%S') }}</small>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Vehicle Detail Modal -->
<div class="modal fade" id="vehicleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-truck"></i> Vehicle Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="vehicleDetails">
                    <!-- Vehicle details will be populated here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include Leaflet CSS and JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<script>
let map, markers = {}, autoRefreshInterval;
let vehicles = [];

// Initialize map
document.addEventListener('DOMContentLoaded', function() {
    map = L.map('map').setView([40.7128, -74.0060], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    
    loadGPSData();
});

function loadGPSData() {
    fetch('/api/gps/live')
        .then(response => response.json())
        .then(data => {
            vehicles = data;
            updateMap();
            updateVehicleList();
            updateStats();
        })
        .catch(error => console.error('Error loading GPS data:', error));
}

function updateMap() {
    // Clear existing markers
    Object.values(markers).forEach(marker => map.removeLayer(marker));
    markers = {};
    
    vehicles.forEach(vehicle => {
        const marker = L.marker([vehicle.latitude, vehicle.longitude])
            .bindPopup(`
                <strong>${vehicle.vehicle_number}</strong><br>
                Speed: ${vehicle.speed.toFixed(1)} km/h<br>
                Fuel: ${vehicle.fuel_level.toFixed(0)}%<br>
                Last Update: ${new Date(vehicle.timestamp).toLocaleTimeString()}
            `)
            .addTo(map);
        
        markers[vehicle.vehicle_id] = marker;
    });
}

function updateVehicleList() {
    const vehicleList = document.getElementById('vehicleList');
    vehicleList.innerHTML = '';
    
    vehicles.forEach(vehicle => {
        const card = document.createElement('div');
        card.className = 'card mb-2';
        card.innerHTML = `
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">${vehicle.vehicle_number}</h6>
                        <small class="text-muted">
                            ${vehicle.speed.toFixed(1)} km/h • 
                            ${vehicle.fuel_level.toFixed(0)}% fuel
                        </small>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-${vehicle.speed > 30 ? 'success' : vehicle.speed > 10 ? 'warning' : 'secondary'}">
                            ${vehicle.speed.toFixed(0)} km/h
                        </span>
                        <br>
                        <small class="text-muted">${new Date(vehicle.timestamp).toLocaleTimeString()}</small>
                    </div>
                </div>
            </div>
        `;
        vehicleList.appendChild(card);
    });
}

function updateStats() {
    if (vehicles.length === 0) return;
    
    const activeVehicles = vehicles.length;
    const avgSpeed = vehicles.reduce((sum, v) => sum + v.speed, 0) / vehicles.length;
    const avgFuelLevel = vehicles.reduce((sum, v) => sum + v.fuel_level, 0) / vehicles.length;
    
    document.getElementById('activeVehicles').textContent = activeVehicles;
    document.getElementById('avgSpeed').textContent = avgSpeed.toFixed(1) + ' km/h';
    document.getElementById('avgFuelLevel').textContent = avgFuelLevel.toFixed(0) + '%';
}

function refreshGPS() {
    loadGPSData();
}

function toggleAutoRefresh() {
    const icon = document.getElementById('autoRefreshIcon');
    const text = document.getElementById('autoRefreshText');
    
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        icon.className = 'fas fa-play';
        text.textContent = 'Auto Refresh';
    } else {
        autoRefreshInterval = setInterval(loadGPSData, 10000); // Refresh every 10 seconds
        icon.className = 'fas fa-pause';
        text.textContent = 'Stop Auto';
    }
}

// Auto-refresh every 30 seconds
setInterval(loadGPSData, 30000);
</script>
{% endblock %} 